@page "/Imdb"
@inherits ComponenteCore

<RadioGroup TValue="TypeMedia" CheckedValue="Settings.TypeMedia" Buttons="true" Margin="Margin.Is2.FromBottom" CheckedValueChanged="TypeMediaChanged">
    <Radio TValue="TypeMedia" Value="@(TypeMedia.movie)"><Blazorise.Icon Name="FontAwesomeIcons.Video"></Blazorise.Icon> Movies</Radio>
    <Radio TValue="TypeMedia" Value="@(TypeMedia.tv)"><Blazorise.Icon Name="FontAwesomeIcons.Tv"></Blazorise.Icon> TV Shows</Radio>
</RadioGroup>

<CardMediaList @ref="cardPopular" Service="@servicePopular" CardHeader="Popular (updated daily)" FindExternalId="FindExternalId"></CardMediaList>
<CardMediaList @ref="cardTopRated" Service="@serviceTopRated" CardHeader="@($"Top Rated")" FindExternalId="FindExternalId"></CardMediaList>
@if (Settings.TypeMedia == TypeMedia.movie)
{
    <CardMediaList @ref="cardUpcoming" Service="@serviceUpcoming" CardHeader="@($"Upcoming")" ShowOnlyYear="false"></CardMediaList>
}

@code {
    public CardMediaList cardPopular { get; set; }
    public CardMediaList cardTopRated { get; set; }
    public CardMediaList cardUpcoming { get; set; }

    public IMediaListService servicePopular { get; set; } = new Services.IMDB.PopularService();
    public IMediaListService serviceTopRated { get; set; } = new Services.IMDB.TopRatedService();
    public IMediaListService serviceUpcoming { get; set; } = new Services.IMDB.UpcomingService();

    public bool FindExternalId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        FindExternalId = Settings.TypeMedia == TypeMedia.tv;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            IsLoading = true;

            await LoadData(Settings);

            IsLoading = false;
        }
    }

    protected async Task LoadData(Settings Settings)
    {
        _ = cardPopular.LoadData(Settings);
        _ = cardTopRated.LoadData(Settings);

        if (Settings.TypeMedia == TypeMedia.movie)
        {
            _ = cardUpcoming.LoadData(Settings);
        }
    }

    private async Task TypeMediaChanged(TypeMedia type)
    {
        Settings.TypeMedia = type;

        await LoadData(Settings);
    }
}