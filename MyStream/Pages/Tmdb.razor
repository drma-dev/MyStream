@page "/Tmdb"
@inherits ComponenteCore
@inject IStringLocalizer<App> L
@using MyStream.Modal.Enum
@using MyStream.Modal

<HeadPage ImageSource="logo/tmdb.png" Text="@L["tmdb_desc"]" Link="https://www.themoviedb.org/"></HeadPage>

<CardMediaList @ref="cardPopular" Service="@servicePopular" CardHeader="@L["Popular"]" HasTV="true"></CardMediaList>
<CardMediaList @ref="cardTopRated" Service="@serviceTopRated" CardHeader="@($"{L["TopRated"]} ({Settings.Region})")" HasTV="true"></CardMediaList>
<CardMediaList @ref="cardUpcoming" Service="@serviceUpcoming" CardHeader="@($"{L["ComingSoon"]} ({Settings?.Region})")" ShowOnlyYear="false"></CardMediaList>

@code {
    public CardMediaList cardPopular { get; set; }
    public CardMediaList cardTopRated { get; set; }
    public CardMediaList cardUpcoming { get; set; }

    public IMediaListService servicePopular { get; set; } = new Services.TMDB.PopularService();
    public IMediaListService serviceTopRated { get; set; } = new Services.TMDB.TopRatedService();
    public IMediaListService serviceUpcoming { get; set; } = new Services.TMDB.UpcomingService();

    protected override void OnInitialized()
    {
        base.OnInitialized();

        RefreshCore.RegionChanged = new EventCallbackFactory().Create(this, async (Region value) => { Settings.Region = value; await LoadData(Settings, true); });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            IsLoading = true;

            await LoadData(Settings);

            IsLoading = false;
        }
    }

    protected async Task LoadData(Settings settings, bool clearData = false)
    {
        await cardPopular.LoadData(settings, clearData: clearData);
        await cardTopRated.LoadData(settings, clearData: clearData);
        await cardUpcoming.LoadData(settings, clearData: clearData);
    }
}